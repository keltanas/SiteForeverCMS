<?xml version="1.0"?>
<!-- build.xml -->

<project name="main" default="main">

    <property name="basedir" value="${project.basedir}"></property>
    <property name="destdir" value="${user.home}/siteforever"></property>

    <property name="version" value="0.3"></property>
    <property name="svn" value="http://svn.stdel.ru/svn/siteforever/trunk"></property>
    <property name="git" value="git://github.com/keltanas/SiteForeverCMS.git"></property>

    <property name="theme" value="basic"></property>

    <property name="db_login" value="siteforever"></property>
    <property name="db_password" value="siteforever"></property>
    <property name="db_server" value="localhost"></property>
    <property name="db_name" value="siteforever"></property>


    <target name="main">
        <echo>To start setup use :$ phing setup</echo>
    </target>

    <target name="svn">
        <svnupdate todir="${basedir}"/>
        <svnlastrevision workingcopy="." repositoryurl="${svn}" propertyname="revision" />
        <echo>Revision: ${revision}</echo>
    </target>

    <target name="git">
        <gitpull repository="${git}" all="true" />
    </target>

    <!-- Setup on this server -->
    <target name="setup">

        <!-- clear properties and cache -->
        <echo message="Clear properties and cache"></echo>

        <delete dir="${destdir}/protected"></delete>
        <delete file="${destdir}/images"></delete>
        <delete file="${destdir}/misc"></delete>
        <delete file="${destdir}/themes/basic"></delete>

        <echo message="Create application structure"></echo>

        <mkdir dir="${destdir}/files"></mkdir>

        <mkdir dir="${destdir}/protected"></mkdir>
        <mkdir dir="${destdir}/protected/_runtime"></mkdir>
        <mkdir dir="${destdir}/protected/_runtime/_templates_c"></mkdir>
        <mkdir dir="${destdir}/protected/config"></mkdir>

        <symlink link="${destdir}/images" target="${basedir}/images"></symlink>
        <symlink link="${destdir}/misc" target="${basedir}/misc"></symlink>

        <mkdir dir="${destdir}/themes"></mkdir>
        <mkdir dir="${destdir}/themes/${phing.project.name}"></mkdir>
        <mkdir dir="${destdir}/themes/${phing.project.name}/css"></mkdir>
        <mkdir dir="${destdir}/themes/${phing.project.name}/images"></mkdir>
        <mkdir dir="${destdir}/themes/${phing.project.name}/js"></mkdir>
        <mkdir dir="${destdir}/themes/${phing.project.name}/templates"></mkdir>

        <symlink link="${destdir}/themes/basic" target="${basedir}/themes/basic"></symlink>


        <copy file="${basedir}/.htaccess" tofile="${destdir}/.htaccess" overwrite="true"></copy>
        <copy file="${basedir}/modules.php" tofile="${destdir}/modules.php" overwrite="true"></copy>
        <copy file="${basedir}/bootstrap.php" tofile="${destdir}/bootstrap.php" overwrite="true"></copy>

        <!-- config -->
        <copy file="${basedir}/protected/config/sample.php"
              tofile="${destdir}/protected/config/${phing.project.name}.php"
              overwrite="true">
            <filterchain>
                <replacetokens>
                    <token key="theme"      value="${theme}"></token>
                    <token key="db_login"   value="${db_login}"></token>
                    <token key="db_password" value="${db_password}"></token>
                    <token key="db_server"  value="${db_server}"></token>
                    <token key="db_name"    value="${db_name}"></token>
                </replacetokens>
            </filterchain>
        </copy>
    </target>

    <!-- Build an autonomous project  -->
    <target name="build" depends="test">

        <property name="distribname" value="siteforever_${version}.${revision}.tgz"></property>
        <echo>Distribution file: ${distribname}</echo>

        <delete file="${user.home}/projects/${distribname}"></delete>

        <delete dir="${destdir}"></delete>

        <mkdir dir="${destdir}"></mkdir>

        <copy todir="${destdir}">
            <fileset dir="${basedir}">
                <exclude name=".idea/**"></exclude>
                <exclude name="files/**"></exclude>
                <exclude name="test/**"></exclude>
                <exclude name="protected/_runtime/**"></exclude>
                <exclude name="protected/config/**"></exclude>
                <exclude name="functionsTest.php"></exclude>
                <exclude name="build.xml"></exclude>
                <exclude name="info.php"></exclude>
                <exclude name="install.php"></exclude>
                <exclude name="pack.php"></exclude>
                <exclude name="todo.txt"></exclude>
            </fileset>
            <filterchain>
                <replacetokens>
                    <token key="version" value="${version}.${revision}"></token>
                </replacetokens>
            </filterchain>
        </copy>

        <!-- make other dirs -->
        <mkdir dir="${destdir}/protected/_runtime/_templates_c"></mkdir>
        <mkdir dir="${destdir}/protected/config"></mkdir>
        <mkdir dir="${destdir}/files"></mkdir>

        <!-- config -->
        <copy file="${basedir}/protected/config/sample.php"
              tofile="${destdir}/protected/config/${phing.project.name}.php"
              overwrite="true">
            <filterchain>
                <replacetokens>
                    <token key="theme"      value="${theme}"></token>
                    <token key="db_login"   value="${db_login}"></token>
                    <token key="db_password" value="${db_password}"></token>
                    <token key="db_server"  value="${db_server}"></token>
                    <token key="db_name"    value="${db_name}"></token>
                </replacetokens>
            </filterchain>
        </copy>

        <!-- coping .htaccess files -->
        <copy todir="${destdir}">
            <fileset dir="${basedir}">
                <include name="**/.htaccess"></include>
            </fileset>
        </copy>

        <!-- create disptibution archive -->
        <tar destFile="${user.home}/projects/${distribname}" compression="gzip">
            <fileset dir="${destdir}">
                <include name="**/**" />
                <include name="**/.htaccess" />
            </fileset>
        </tar>

    </target>

    <target name="test" depends="git">
        <phpunit bootstrap="test/bootstrap.php">
            <formatter type="plain" usefile="false"/>
            <batchtest>
                <fileset dir="test">
                    <include name="**/*Test.php"/>
                </fileset>
            </batchtest>
        </phpunit>
    </target>


</project>
